<div class="module-header">
  <h2><i class="fas fa-cloud"></i> Flight weather</h2>
  <p class="panel-subtitle">Conditions at departure and arrival for all segments</p>
</div>

<div id="countdown" aria-live="polite" style="margin-bottom:0.8rem;">
  <i class="fas fa-hourglass-half"></i>
  <span id="flight-countdown">Loading countdown‚Ä¶</span>
</div>

<div class="table-wrapper">
  <table aria-live="polite">
    <thead>
      <tr>
        <th>Segment</th>
        <th>Local time</th>
        <th>Icon</th>
        <th>Weather</th>
      </tr>
    </thead>
    <tbody id="flight-weather-rows"></tbody>
  </table>
</div>

<script>
// --- FLIGHT WEATHER MODULE ---

// Your airport coordinates
const airports = {
  ATW: { name: "Appleton", lat: 44.2580, lon: -88.5193, tz: "America/Chicago" },
  DTW: { name: "Detroit", lat: 42.2162, lon: -83.3554, tz: "America/Detroit" },
  CDG: { name: "Paris CDG", lat: 49.0097, lon: 2.5479, tz: "Europe/Paris" }
};

const segments = [
  { from: "ATW", to: "DTW", time: "2025-12-01T17:21" },
  { from: "DTW", to: "CDG", time: "2025-12-01T21:20" },
  { from: "CDG", to: "DTW", time: "2025-12-08T10:30" },
  { from: "DTW", to: "ATW", time: "2025-12-08T16:50" }
];

function wxIcon(code) {
  if (code === 0) return "‚òÄÔ∏è";
  if (code <= 3) return "‚õÖ";
  if (code <= 48) return "üå´Ô∏è";
  if (code <= 65) return "üåßÔ∏è";
  if (code <= 82) return "üå¶Ô∏è";
  if (code <= 95) return "‚õàÔ∏è";
  return "üå©Ô∏è";
}

async function fetchWx(lat, lon, tz) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=${encodeURIComponent(tz)}`;
  const res = await fetch(url);
  return res.json();
}

async function loadFlightWeather() {
  const tbody = document.getElementById("flight-weather-rows");
  tbody.innerHTML = "<tr><td colspan='4'>Loading‚Ä¶</td></tr>";

  const rows = [];

  for (const seg of segments) {
    const a = airports[seg.from];
    const b = airports[seg.to];

    const wxA = await fetchWx(a.lat, a.lon, a.tz);
    const wxB = await fetchWx(b.lat, b.lon, b.tz);

    rows.push(`
      <tr>
        <td><strong>${a.name} ‚Üí ${b.name}</strong></td>
        <td>${seg.time}</td>
        <td>${wxIcon(wxA.current_weather.weathercode)}</td>
        <td>${Math.round(wxA.current_weather.temperature)}¬∞F ‚Üí ${Math.round(wxB.current_weather.temperature)}¬∞F</td>
      </tr>
    `);
  }

  tbody.innerHTML = rows.join("");

  // Update countdown
  const cd = document.getElementById("flight-countdown");
  const dep = new Date("2025-12-01T17:21:00");
  const now = new Date();
  const diff = dep - now;

  if (diff > 0) {
    const hrs = Math.floor(diff / 1000 / 3600);
    const mins = Math.floor((diff / 1000 / 60) % 60);
    cd.textContent = `${hrs}h ${mins}m until departure`;
  } else {
    cd.textContent = "Trip has begun!";
  }
}

loadFlightWeather();
</script>
