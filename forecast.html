<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flight Forecast Detail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)),
        url("paris-christmas-markets.jpg") no-repeat center center fixed;
      background-size: cover;
      color: #f5f5f5;
      margin: 0;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .card {
      width: 100%;
      max-width: 600px;
      background: rgba(20, 27, 51, 0.9);
      backdrop-filter: blur(4px);
      border-radius: 10px;
      padding: 1.2rem 1.4rem;
      box-shadow: 0 8px 25px rgba(0,0,0,0.6);
    }

    h1 {
      font-size: 1.4rem;
      margin: 0.2rem 0 0.4rem 0;
      text-align: center;
      text-shadow: 0 2px 5px rgba(0,0,0,0.7);
    }

    h2 {
      font-size: 1rem;
      margin: 0;
      text-align: center;
      opacity: 0.9;
      text-shadow: 0 1px 3px rgba(0,0,0,0.7);
    }

    #meta {
      font-size: 0.9rem;
      text-align: center;
      margin-top: 0.4rem;
      opacity: 0.85;
    }

    #status {
      font-size: 0.9rem;
      text-align: center;
      margin: 0.4rem 0;
      opacity: 0.9;
    }

    .badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      font-weight: 700;
      margin: 0.4rem 0;
      font-size: 1rem;
    }
    .good { background: #133a20; color: #61e27b; border: 1px solid #61e27b; }
    .bad  { background: #3a1414; color: #ff6b6b; border: 1px solid #ff6b6b; }

    dl {
      margin: 0.5rem 0 0 0;
    }
    dt {
      font-weight: 600;
      margin-top: 0.4rem;
      font-size: 0.9rem;
    }
    dd {
      margin: 0.1rem 0 0.2rem 0;
      font-size: 0.9rem;
      opacity: 0.95;
    }

    a.back {
      margin-top: 0.6rem;
      font-size: 0.9rem;
      color: #9ec0ff;
      text-decoration: none;
    }
    a.back:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Flight Forecast Detail</h1>
    <h2 id="airportTitle"></h2>
    <div id="meta"></div>
    <div id="status">Loading forecast...</div>
    <div id="result"></div>
    <a href="index.html" class="back">Back to main dashboard</a>
  </div>

<script>
const airports = {
  ATW: {
    code: "ATW",
    name: "Appleton (ATW)",
    lat: 44.2581,
    lon: -88.5191,
    timezone: "America/Chicago"
  },
  DTW: {
    code: "DTW",
    name: "Detroit (DTW)",
    lat: 42.2162,
    lon: -83.3554,
    timezone: "America/New_York"
  },
  CDG: {
    code: "CDG",
    name: "Paris Charles de Gaulle (CDG)",
    lat: 49.0097,
    lon: 2.5479,
    timezone: "Europe/Paris"
  }
};

const airportTitle = document.getElementById("airportTitle");
const meta = document.getElementById("meta");
const statusBox = document.getElementById("status");
const result = document.getElementById("result");

function getParams() {
  const p = new URLSearchParams(window.location.search);
  return {
    airport: p.get("airport"),
    time: p.get("time")
  };
}

function nearestIndex(times, target) {
  let best = 0;
  let bestDiff = Number.POSITIVE_INFINITY;
  const t = target.getTime();
  for (let i = 0; i < times.length; i++) {
    const diff = Math.abs(new Date(times[i]).getTime() - t);
    if (diff < bestDiff) { bestDiff = diff; best = i; }
  }
  return best;
}

function classify(code, wind, precip) {
  const badCodes = [65,66,67,71,73,75,77,80,81,82,85,86,95,96,99];
  if (badCodes.includes(code)) return "BAD";
  if (wind >= 45) return "BAD";
  if (precip >= 4) return "BAD";
  return "GOOD";
}

function describe(code) {
  const map = {
    0:"Clear",
    1:"Mainly clear",
    2:"Partly cloudy",
    3:"Overcast",
    45:"Fog",
    48:"Rime fog",
    51:"Light drizzle",
    53:"Drizzle",
    55:"Heavy drizzle",
    61:"Light rain",
    63:"Moderate rain",
    65:"Heavy rain",
    71:"Light snow",
    73:"Snow",
    75:"Heavy snow",
    80:"Showers",
    81:"Showers",
    82:"Heavy showers",
    95:"Thunderstorm",
    96:"Storm hail",
    99:"Severe hail"
  };
  return map[code] || "Weather";
}

async function loadForecast() {
  const { airport, time } = getParams();
  if (!airport || !time) {
    statusBox.textContent = "Missing airport or time in the link.";
    return;
  }

  const ap = airports[airport];
  if (!ap) {
    statusBox.textContent = "Unknown airport code: " + airport;
    return;
  }

  const eventDate = new Date(time);
  airportTitle.textContent = ap.name;
  meta.textContent = "Requested event time: " + eventDate.toLocaleString();

  statusBox.textContent = "Fetching data from Open Meteo...";

  const url = `https://api.open-meteo.com/v1/forecast?latitude=${ap.lat}&longitude=${ap.lon}&hourly=temperature_2m,weathercode,precipitation,windspeed_10m&timezone=${encodeURIComponent(ap.timezone)}&forecast_days=16`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Forecast error " + res.status);
    const data = await res.json();

    const times = data.hourly.time;
    const temps = data.hourly.temperature_2m;
    const precs = data.hourly.precipitation;
    const codes = data.hourly.weathercode;
    const winds = data.hourly.windspeed_10m;

    const idx = nearestIndex(times, eventDate);
    const forecastTime = new Date(times[idx]);

    const tc = temps[idx];
    const prec = precs[idx];
    const code = codes[idx];
    const wind = winds[idx];

    const rating = classify(code, wind, prec);
    const label = describe(code);
    const f = tc * 9 / 5 + 32;

    statusBox.textContent = "Nearest forecast hour: " + forecastTime.toLocaleString();

    const badgeClass = rating === "GOOD" ? "good" : "bad";
    const badgeText = rating === "GOOD" ? "ðŸŸ¢ GOOD" : "ðŸ”´ BAD";

    result.innerHTML = `
      <div style="text-align:center;">
        <span class="badge ${badgeClass}">${badgeText}</span>
      </div>
      <dl>
        <dt>Condition</dt>
        <dd>${label}</dd>
        <dt>Temperature</dt>
        <dd>${tc.toFixed(1)} C (${f.toFixed(0)} F)</dd>
        <dt>Wind</dt>
        <dd>${wind.toFixed(0)} km/h</dd>
        <dt>Precipitation</dt>
        <dd>${prec.toFixed(1)} mm</dd>
        <dt>Airport</dt>
        <dd>${ap.name} [${ap.code}]</dd>
      </dl>
    `;
  } catch (e) {
    console.error(e);
    statusBox.textContent = "Failed to load forecast.";
    result.textContent = "";
  }
}

loadForecast();
</script>

</body>
</html>
